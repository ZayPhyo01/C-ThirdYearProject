using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Data.SqlClient;
using System.Data;

namespace WebApp.Pages
{
    public partial class ShoppingCart : System.Web.UI.Page
    {
        string source = @"Data Source=(LocalDB)\v11.0;AttachDbFilename=C:\Users\Administrator\Desktop\ASP.NetSecondTerm\GarageManagerDB.mdf;Integrated Security=True;Connect Timeout=30";
        SqlConnection cn = new SqlConnection();
        DataTable table;
        string clientId;
        protected void Page_Load(object sender, EventArgs e)
        {
            clientId = Session["UserID"].ToString();
            cn = new SqlConnection(source);
            SqlCommand cmd = new SqlCommand("Select Cart1.Id,Cart1.ProductId,Product1.Name,Product1.Price,Cart1.qty,Cart1.Amount from Cart1, Product1 where Cart1.ProductId=Product1.Id and ClientID=@id and IsInCart=@cart", cn);
           // SqlCommand cmd = new SqlCommand("Select * from Cart1", cn);
            cmd.Parameters.AddWithValue("@id", clientId);
            cmd.Parameters.AddWithValue("@cart", true);
            SqlDataAdapter da = new SqlDataAdapter();
            da.SelectCommand = cmd;
            SqlCommandBuilder cb = new SqlCommandBuilder(da);
            table = new DataTable();
            table.Locale = System.Globalization.CultureInfo.InvariantCulture;
            da.Fill(table);
            if (table.Rows.Count > 0)
            {
                // Automatically generate the DataGridView columns.
                GridView1.AutoGenerateColumns = true;

                // Set up the data source.
                GridView1.DataSource = table;



                // Set the DataGridView control's border.
                GridView1.BorderStyle = BorderStyle.Dotted;

                // Put the cells in edit mode when user enters them.
                GridView1.AutoGenerateEditButton = true;
                GridView1.AutoGenerateDeleteButton = true;
                GridView1.AllowPaging = true;
                GridView1.Visible = true;
                GridView1.DataBind();
                fillTotal();
            }
            else
            {
                litTotal.Text = "$ 0.00 ";
                litVat.Text = "$ 0.00";
                
                LitTotAmount.Text = "$ 0.00";
            }
        }

        protected void GridView1_RowEditing(object sender, GridViewEditEventArgs e)
        {
            GridViewRow row1 = GridView1.Rows[e.NewEditIndex];
           
            int rowId = Convert.ToInt32(row1.Cells[1].Text);
            Response.Redirect("~/Pages/FloraEdit.aspx?id=" + rowId);

        }

        protected void GridView1_RowDeleting(object sender, GridViewDeleteEventArgs e)
        {
            table.Rows.RemoveAt(e.RowIndex);
            GridView1.DataSource = table;
            GridView1.DataBind();
            fillTotal();
            
            
        }

        private void fillTotal()
        {
            cn = new SqlConnection(source);
            cn.Open();
            int tot = 0;
            
            SqlCommand cmd = new SqlCommand("Select Sum(Amount) from Cart1 where ClientID=@id and IsInCart=@cart", cn);

            cmd.Parameters.AddWithValue("@id", clientId);
            cmd.Parameters.AddWithValue("@cart", true);
            tot = Convert.ToInt32(cmd.ExecuteScalar());
            cn.Close();
            double  vat=tot*0.01;
            double totAmt=tot+15+vat;
            litTotal.Text = tot.ToString() +" kyats";
            litVat.Text = vat.ToString() + " kyats";
            LitTotAmount.Text =  totAmt.ToString() + " kyats";
        }
    }
}